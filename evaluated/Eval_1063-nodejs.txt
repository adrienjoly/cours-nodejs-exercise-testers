
Stop and remove previous Docker containers...

ğŸ³ Generate and run Dockerfile from ./student-code/...

ğŸ‘¾ Run test suite against container...

    Lecture du code source fourni
    â„¹ const express = require('express');
      const app = express();
      const MongoClient = require('mongodb').MongoClient;
      require("dotenv").config();
      const URL = process.env.MONGODB_URL;
      const COLLECTION = process.env.MONGODB_COLLECTION;
      const DBNAME = process.env.MONGODB_DATABASE;

      const PORT = process.env.PORT || 3000;

      app.use(express.json());
      app.listen(PORT, () => console.log(`Server is listening on port ${PORT}...`))

      let ERROR_SERV = false; 

      ( async() => {

          const client = new MongoClient(URL);
          try {
              await client.connect();
          } catch (err) {
              ERROR_SERV = true;
          }

          app.post('/', async function (req, res) {
              const db = client.db(DBNAME);

              if (req.body.nom != undefined) {
                  await db.collection(COLLECTION).insertOne({ nom: req.body.nom });
                  res.send('Bienvenue, '+req.body.nom+'.') 
              } else {
                  res.send('Il manque votre nom.')
              }
          })
    
          app.get('/', async function (req, res) {
              if (ERROR_SERV) {
                  res.send('J\'ai perdu la mÃ©moire...')
              }

              const db = client.db(DBNAME);
              const col = db.collection(COLLECTION);
              let last = await col.find().sort({ _id: -1 }).limit(1).toArray();

              if (last[0].nom) {
                  res.send('La derniÃ¨re personne que j\'ai rencontrÃ©e est: '+last[0].nom+'.')
              } else {
                  res.send('Je n\'ai rencontrÃ© personne pour l\'instant')
              }
          })
      })();
  âœ” server.js utilise seulement await pour rÃ©cupÃ©rer les valeurs promises
  âœ” server.js contient l'inteÌgraliteÌ du code source de votre programme
  âœ” package.json permet d'installer les deÌpendances neÌcessaires aÌ€ l'aide de npm install
  âœ– package.json permet de deÌmarrer le serveur aÌ€ l'aide de npm start `t.regex()` must be called with a string
  âœ– README.md inclue les instructions aÌ€ suivre pour installer, exeÌcuter et tester le serveur 
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'nom' of undefined
(node) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). (rejection id: 1)
  âœ– (1) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/ 
  âœ” (2) POST / {} -> /Il manque votre nom/
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'nom' of undefined
  âœ– (3) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/ 
  âœ– (4) POST / "nom=adrien" -> /Bienvenue, adrien/ 
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'nom' of undefined
  âœ– (5) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/ 
  âœ– (6) POST / "nom=michelle" -> /Bienvenue, michelle/ 
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'nom' of undefined
  âœ– (7) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/ 
  âœ– MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur 
  âœ– (8) GET / -> "J'ai perdu la meÌmoire...", si la db ne fonctionne plus 
  â”€

  package.json permet de deÌmarrer le serveur aÌ€ l'aide de npm start

  test-partiel.js:109

   108:     const { scripts } = JSON.parse(await runInDocker('cat package.json'â€¦
   109:     t.regex(scripts.start, /node server.js/);                           
   110:   }                                                                     

  `t.regex()` must be called with a string

  Called with:

  undefined

  â€º test.serial (test-partiel.js:109:7)



  README.md inclue les instructions aÌ€ suivre pour installer, exeÌcuter et tester le serveur

  test-partiel.js:119

   118:     t.regex(readme, /node server|npm start/);
   119:     t.regex(readme, /npm test|curl/);        
   120:   }                                          

  Value must match expression:

  `### Partiel Node.JS âŠ
  âŠ
  Projet qui a pour but de rÃ©pondre bonjour Ã  une personne avec une mise en mÃ©moire des noms.âŠ
  âŠ
  DÃ©pendances : âŠ
  -  "body-parser": "^1.19.0",âŠ
  -  "dotenv": "^8.2.0",âŠ
  -  "express": "^4.17.1",âŠ
  -  "mongodb": "^3.5.9"âŠ
  âŠ
  Pour l'installer :âŠ
  âŠ
  - ```npm install```âŠ
  âŠ
  Pour le lancer : âŠ
  - ```npm start```âŠ
  âŠ
  ## SetupâŠ
  âŠ
  Pour pouvoir setup le projet il y a 3 variables d'environnement :âŠ
  âŠ
  ```MONGODB_URL``` : Url de la base de donnÃ©e mongo dbâŠ
  ```MONGODB_COLLECTION```: Nom de la collection qu'on veut exploitÃ©âŠ
  ```MONGODB_DATABASE```: Nom de la base de donnÃ©e mongo dbâŠ
  âŠ
  ## POST /âŠ
  - Prend un champ ```nom``` au format URL-EncodedâŠ
  âŠ
  RÃ©pond :âŠ
  - Soit ```Bienvenu, XXX```(XXX Ã©tant la valeur passÃ©e dans le champ ```nom```)âŠ
  - Soit ```ÃŒl manque votre nom.```, si aucun ```nom```n'a Ã©tÃ© reÃ§uâŠ
  âŠ
  ## GET /âŠ
  - Prend un champ ```nom``` au format URL-EncodedâŠ
  âŠ
  RÃ©pond :âŠ
  - Soit ```La derniÃ¨re personne que j'ai rencontrÃ©e est: XXX.```(XXX Ã©tant le dernier ```nom``` transmis Ã  ```POST /```)âŠ
  - Soit ```Je n'ai rencontrÃ© personne pour l'instant```, si aucun ```nom```n'a Ã©tÃ© transmis Ã  ```POST /``` pour l'instant;âŠ
  - Soit ```J'ai perdu la mÃ©moire...```, si un problÃ¨me technique empÃªche la rÃ©cupÃ©ration du nom.`

  Regular expression:

  /npm test|curl/

  â€º test.serial (test-partiel.js:119:7)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  (1) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /Je n'ai rencontreÌ personne pour l'instant/

  â€º test.serial (test-partiel.js:167:9)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  (3) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /Je n'ai rencontreÌ personne pour l'instant/

  â€º test.serial (test-partiel.js:167:9)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  (4) POST / "nom=adrien" -> /Bienvenue, adrien/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'Il manque votre nom.'

  Regular expression:

  /Bienvenue, adrien/

  â€º test.serial (test-partiel.js:167:9)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  (5) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/

  â€º test.serial (test-partiel.js:167:9)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  (6) POST / "nom=michelle" -> /Bienvenue, michelle/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'Il manque votre nom.'

  Regular expression:

  /Bienvenue, michelle/

  â€º test.serial (test-partiel.js:167:9)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  (7) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/

  â€º test.serial (test-partiel.js:167:9)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur

  test-partiel.js:188

   187:     );                                                       
   188:     t.is(docs.length, 1);                                    
   189:     t.deepEqual(Object.keys(docs[0]).sort(), ['_id', 'nom']);

  Difference:

  - 0
  + 1

  â€º test.serial (test-partiel.js:188:7)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)



  (8) GET / -> "J'ai perdu la meÌmoire...", si la db ne fonctionne plus

  test-partiel.js:200

   199:     const { data } = await axios.get(`http://localhost:${envVars.PORT}/â€¦
   200:     t.regex(data, /J'ai perdu la meÌmoire/);                            
   201:   }                                                                     

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /J'ai perdu la meÌmoire/

  â€º test.serial (test-partiel.js:200:7)
  â€º process._tickCallback (internal/process/next_tick.js:68:7)

  â”€

  10 tests failed

ğŸ§¹ Stop and remove Docker containers...
