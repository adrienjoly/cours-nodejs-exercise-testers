Commentaires:
- usage d'un callback -- avec gestion incorrecte d'erreurs -- dans appel Ã  insertOne().
- POST rÃ©pond avant que le nom ait Ã©tÃ© enregistrÃ©.
- la condition req.body.nom === "" ne couvre pas le cas dans lequel le paramÃ¨tre nom n'est pas transmis.

Stop and remove previous Docker containers...

ğŸ³ Generate and run Dockerfile from ./submissions/1577-nodejs...

ğŸ‘¾ Run test suite against container...

    Lecture du code source fourni
    â„¹ const MongoClient = require("mongodb").MongoClient;
      const express = require("express");
      const app = express();
      const bodyParser = require("body-parser");
      const { response } = require("express");
      require("dotenv").config();
      const PORT = process.env.PORT || 3000;
      const dbName = process.env.MONGODB_DATABASE;
      const client = new MongoClient(process.env.MONGODB_URL);

      (async () => {
        await client.connect();
        const db = client.db(dbName);
        const collection = db.collection(process.env.MONGODB_COLLECTION);

        app.use(
          bodyParser.urlencoded({
            extended: true,
          })
        );

        app.post("/", function (req, res) {
          if (req.body.nom === "") res.send("Il manque votre nom.");
          else {
            const user = { nom: req.body.nom };
            try {
              collection.insertOne(user, function (err) {
                if (err) throw err;
              });
            } catch (e) {
              console.error(e);
            }
            res.send(`Bienvenue, ${req.body.nom}.`);
          }
        });

        app.get("/", async function (req, res) {
          try {
            const messages = await collection.findOne({}, { field: "asc", _id: -1 });
            console.log(messages.nom);
            if (messages)
              res.send(
                `La derniÃ¨re personne que j'ai rencontrÃ©e est: ${messages.nom}`
              );
            else res.send("Je n'ai rencontrÃ© personne pour l'instant");
          } catch (e) {
            console.error(e);
            res.send("J'ai perdu la mÃ©moire...");
          }
        });

        app.listen(PORT, function () {
          console.log(`App Listen on ${PORT}`);
        });
      })();

  âœ” server.js utilise seulement await pour rÃ©cupÃ©rer les valeurs promises
  âœ” server.js contient l'inteÌgraliteÌ du code source de votre programme
  âœ” package.json permet d'installer les deÌpendances neÌcessaires aÌ€ l'aide de npm install
  âœ– package.json permet de deÌmarrer le serveur aÌ€ l'aide de npm start `t.regex()` must be called with a string
  âœ– README.md inclue les instructions aÌ€ suivre pour installer, exeÌcuter et tester le serveur 
TypeError: Cannot read property 'nom' of null
  âœ– (1) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/ 
  âœ– (2) POST / {} -> /Il manque votre nom/ 
  âœ– (3) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/ 
  âœ” (4) POST / "nom=adrien" -> /Bienvenue, adrien/
  âœ– (5) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/ 
  âœ” (6) POST / "nom=michelle" -> /Bienvenue, michelle/
  âœ– (7) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/ 
  âœ– MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur 
  âœ– (8) GET / -> "J'ai perdu la meÌmoire...", si la db ne fonctionne plus 
  â”€

  package.json permet de deÌmarrer le serveur aÌ€ l'aide de npm start

  test-partiel.js:109

   108:     const { scripts } = JSON.parse(await runInDocker('cat package.json'â€¦
   109:     t.regex(scripts.start, /node server.js/);                           
   110:   }                                                                     

  `t.regex()` must be called with a string

  Called with:

  undefined

  â€º test-partiel.js:109:7



  README.md inclue les instructions aÌ€ suivre pour installer, exeÌcuter et tester le serveur

  test-partiel.js:118

   117:     t.regex(readme, /npm i/);                
   118:     t.regex(readme, /node server|npm start/);
   119:     t.regex(readme, /npm test|curl/);        

  Value must match expression:

  `# Save Name ServerâŠ
  âŠ
  ===============âŠ
  âŠ
  ## SetupâŠ
  âŠ
  ```âŠ
  $ git clone https://gitlab.eemi.tech/corentin.ravet/node-app.gitâŠ
  $ cd 1577-nodejsâŠ
  $ npm installâŠ
  $ npm run startâŠ
  ```âŠ
  âŠ
  # What it is, what it doesâŠ
  âŠ
  Server that displays name on a single page.âŠ
  On : `http://localhost:3000/`âŠ
  âŠ
  # UsageâŠ
  âŠ
  ============âŠ
  âŠ
  ```âŠ
  $ curl -X POST --header "Content-Type: application/x-www-form-urlencoded" --data "nom=John" http://localhost:3000/âŠ
  $ curl -X POST --header "Content-Type: application/x-www-form-urlencoded" --data "nom=" http://localhost:3000/âŠ
  ```âŠ
  `

  Regular expression:

  /node server|npm start/

  â€º test-partiel.js:118:7



  (1) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'J\'ai perdu la mÃ©moire...'

  Regular expression:

  /Je n'ai rencontreÌ personne pour l'instant/

  â€º test-partiel.js:167:9



  (2) POST / {} -> /Il manque votre nom/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'Bienvenue, undefined.'

  Regular expression:

  /Il manque votre nom/

  â€º test-partiel.js:167:9



  (3) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'La derniÃ¨re personne que j\'ai rencontrÃ©e est: null'

  Regular expression:

  /Je n'ai rencontreÌ personne pour l'instant/

  â€º test-partiel.js:167:9



  (5) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'La derniÃ¨re personne que j\'ai rencontrÃ©e est: null'

  Regular expression:

  /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/

  â€º test-partiel.js:167:9



  (7) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/

  test-partiel.js:167

   166:       const { data } = await axios[method.toLowerCase()](url, body);
   167:       t.regex(data, exp);                                           
   168:     }                                                               

  Value must match expression:

  'La derniÃ¨re personne que j\'ai rencontrÃ©e est: null'

  Regular expression:

  /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/

  â€º test-partiel.js:167:9



  MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur

  test-partiel.js:188

   187:     );                                                       
   188:     t.is(docs.length, 1);                                    
   189:     t.deepEqual(Object.keys(docs[0]).sort(), ['_id', 'nom']);

  Difference:

  - 3
  + 1

  â€º test-partiel.js:188:7



  (8) GET / -> "J'ai perdu la meÌmoire...", si la db ne fonctionne plus

  test-partiel.js:200

   199:     const { data } = await axios.get(`http://localhost:${envVars.PORT}/â€¦
   200:     t.regex(data, /J'ai perdu la meÌmoire/);                            
   201:   }                                                                     

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /J'ai perdu la meÌmoire/

  â€º test-partiel.js:200:7

  â”€

  9 tests failed

ğŸ§¹ Stop and remove Docker containers...
