
Stop and remove previous Docker containers...

üê≥ Generate and run Dockerfile from ./student-code/...

üëæ Run test suite against container...

    Lecture du code source fourni
    ‚Ñπ const express = require('express');
      var fs = require('fs');
      const assert = require('assert');
      var bodyParser = require('body-parser')

      const MongoClient = require('mongodb').MongoClient;
      const app = express();

      const dotenv = require('dotenv');
      dotenv.config();

      const dbName = process.env.MONGODB_DATABASE;
      const uri = process.env.MONGODB_URL;

      const client = new MongoClient(uri, { useNewUrlParser: true });

      app.use(express.json());

      client.connect(err => {

          const db = client.db(dbName);
          const collection = db.collection(process.env.MONGODB_COLLECTION);

          app.post('/', function (req, res) {
              const nameFromPost = req.body.name;
              if (nameFromPost) {
                  (async function() {
                      try {
                          collection.remove({})
                          let user = await collection.insertOne({name:nameFromPost});
                          assert.equal(1, user.insertedCount);
                          res.send(`Bienvenue, " + ${nameFromPost}`);
                      } catch (err) {
                          console.log(err.stack);
                          res.send("Il y a un probl√®me...");
                      }
                  })();
              } else {
                  res.send("Il manque votre nom.");
              }
          });

          app.get('/', function (req, res) {
              //Syntaxe propos√©e par la doc de mongodb: on appelle directement la fonction asynchrone
              (async function() {
                  try {
                      // Le doc nous arrive sous forme de tableau
                      const user = await collection.find({}).toArray();
                      if (user && user.length > 0) {
                          res.send(`La derni√®re personne que j'ai rencontr√©e est: ${user[0].name}`);
                      } else {
                          res.send("Je n'ai rencontr√© personne pour l'instant");
                      }
                  } catch (err) {
                      console.log(err.stack);
                      res.send("J'ai perdu la m√©moire...");
                  }
              })();
          });
      });

      app.listen(process.env.PORT || 3000, function () {
          console.log('Example app listening on port 3000!')
      });

  ‚úî server.js utilise seulement await pour r√©cup√©rer les valeurs promises
  ‚úî server.js contient l'inteÃÅgraliteÃÅ du code source de votre programme
  ‚úî package.json permet d'installer les deÃÅpendances neÃÅcessaires aÃÄ l'aide de npm install
  ‚úñ package.json permet de deÃÅmarrer le serveur aÃÄ l'aide de npm start 
  ‚úñ README.md inclue les instructions aÃÄ suivre pour installer, exeÃÅcuter et tester le serveur 
  ‚úî le serveur r√©pond sur le port 3000
  ‚úñ (1) GET / {} -> /Je n'ai rencontreÃÅ personne pour l'instant/ 
  ‚úî (2) POST / {} -> /Il manque votre nom/
  ‚úñ (3) GET / {} -> /Je n'ai rencontreÃÅ personne pour l'instant/ 
  ‚úñ (4) POST / "nom=adrien" -> /Bienvenue, adrien/ 
  ‚úñ (5) GET / {} -> /La dernieÃÄre personne que j'ai rencontreÃÅe est: adrien/ 
  ‚úñ (6) POST / "nom=michelle" -> /Bienvenue, michelle/ 
  ‚úñ (7) GET / {} -> /La dernieÃÄre personne que j'ai rencontreÃÅe est: michelle/ 
  ‚úñ MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur 
  ‚úñ (8) GET / -> "J'ai perdu la meÃÅmoire...", si la db ne fonctionne plus Rejected promise returned by test

  10 tests failed

  package.json permet de deÃÅmarrer le serveur aÃÄ l'aide de npm start

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:92

   91:     const { scripts } = JSON.parse(await runInDocker('cat package.json')‚Ä¶
   92:     t.regex(scripts.start, /node server.js/);                            
   93:   }                                                                      

  Value must match expression:

  'nodemon server.js'

  Regular expression:

  /node server.js/



  README.md inclue les instructions aÃÄ suivre pour installer, exeÃÅcuter et tester le serveur

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:100

    99:     const readme = await runInDocker('cat README.md');
   100:     t.regex(readme, /npm i/);                         
   101:     t.regex(readme, /node server|npm start/);         

  Value must match expression:

  `# 1497 Partiel‚êä
  ‚êä
  Le but de notre programme est de pouvoir stocker un nom d'utilisateur et de lui souhaiter la bienvenue lorsqu'il arrive sur l'application.‚êä
  L'application doit "se souvenir" du dernier utilisateur, c'est pourquoi nous utilisons mongodb Atlas comme base de donn√©es distantes pour "m√©moriser" le dernier utilisateur.‚êä
  ‚êä
  On donne le nom du dernier utilisateur (le seul enregistr√© dans la collection de la base de donn√©es!) lorsque ‚êä
  l'utilisateur va sur la route "/" en GET.‚êä
  ‚êä
  Si la collection est vide (premi√®re fois) alors le programme lui dit qu'il ne connait personne, et s'il y a une erreur quelconque de lecture de ‚êä
  base de donn√©es alors le programme va dire qu'il a perdu la m√©moire.‚êä
  ‚êä
  Ensuite, on peut ajouter le dernier utilisateur avec la m√©thode POST (toujours sur racine "/")‚êä
  en passant un nom en param√®tre; on utilise le curl avec le bodyParser par exemple.‚êä
  On vide la collection et on enregistre le nouvel utilisateur.`

  Regular expression:

  /npm i/



  (1) GET / {} -> /Je n'ai rencontreÃÅ personne pour l'instant/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:155

   154:       const { data } = await axios[method.toLowerCase()](url, body);
   155:       t.regex(data, exp);                                           
   156:     }                                                               

  Value must match expression:

  'Je n\'ai rencontr√© personne pour l\'instant'

  Regular expression:

  /Je n'ai rencontreÃÅ personne pour l'instant/



  (3) GET / {} -> /Je n'ai rencontreÃÅ personne pour l'instant/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:155

   154:       const { data } = await axios[method.toLowerCase()](url, body);
   155:       t.regex(data, exp);                                           
   156:     }                                                               

  Value must match expression:

  'Je n\'ai rencontr√© personne pour l\'instant'

  Regular expression:

  /Je n'ai rencontreÃÅ personne pour l'instant/



  (4) POST / "nom=adrien" -> /Bienvenue, adrien/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:155

   154:       const { data } = await axios[method.toLowerCase()](url, body);
   155:       t.regex(data, exp);                                           
   156:     }                                                               

  Value must match expression:

  'Il manque votre nom.'

  Regular expression:

  /Bienvenue, adrien/



  (5) GET / {} -> /La dernieÃÄre personne que j'ai rencontreÃÅe est: adrien/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:155

   154:       const { data } = await axios[method.toLowerCase()](url, body);
   155:       t.regex(data, exp);                                           
   156:     }                                                               

  Value must match expression:

  'Je n\'ai rencontr√© personne pour l\'instant'

  Regular expression:

  /La dernieÃÄre personne que j'ai rencontreÃÅe est: adrien/



  (6) POST / "nom=michelle" -> /Bienvenue, michelle/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:155

   154:       const { data } = await axios[method.toLowerCase()](url, body);
   155:       t.regex(data, exp);                                           
   156:     }                                                               

  Value must match expression:

  'Il manque votre nom.'

  Regular expression:

  /Bienvenue, michelle/



  (7) GET / {} -> /La dernieÃÄre personne que j'ai rencontreÃÅe est: michelle/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:155

   154:       const { data } = await axios[method.toLowerCase()](url, body);
   155:       t.regex(data, exp);                                           
   156:     }                                                               

  Value must match expression:

  'Je n\'ai rencontr√© personne pour l\'instant'

  Regular expression:

  /La dernieÃÄre personne que j'ai rencontreÃÅe est: michelle/



  MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:176

   175:     );                                                       
   176:     t.is(docs.length, 1);                                    
   177:     t.deepEqual(Object.keys(docs[0]).sort(), ['_id', 'nom']);

  Difference:

  - 0
  + 1



  (8) GET / -> "J'ai perdu la meÃÅmoire...", si la db ne fonctionne plus

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/node_modules/axios/lib/core/createError.js:16

  Rejected promise returned by test. Reason:

  Error {
    code: 'ECONNABORTED',
    config: {
      adapter: Function httpAdapter {},
      data: undefined,
      headers: {
        Accept: 'application/json, text/plain, */*',
        'User-Agent': 'axios/0.19.0',
      },
      maxContentLength: -1,
      method: 'get',
      timeout: 1500,
      transformRequest: [
        Function transformRequest {},
      ],
      transformResponse: [
        Function transformResponse {},
      ],
      url: 'http://localhost:3000/',
      validateStatus: Function validateStatus {},
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
    },
    isAxiosError: true,
    request: Writable {
      _currentRequest: ClientRequest {
        _contentLength: 0,
        _ended: false,
        _events: Object { ‚Ä¶ },
        _eventsCount: 6,
        _hasBody: true,
        _header: `GET / HTTP/1.1‚êç‚êä
        Accept: application/json, text/plain, */*‚êç‚êä
        User-Agent: axios/0.19.0‚êç‚êä
        Host: localhost:3000‚êç‚êä
        Connection: close‚êç‚êä
        ‚êç‚êä
        `,
        _headerSent: true,
        _last: true,
        _maxListeners: undefined,
        _onPendingData: Function noopPendingOutput {},
        _redirectable: [Circular],
        _removedConnection: false,
        _removedContLen: false,
        _removedTE: false,
        _trailer: '',
        aborted: 1595009687475,
        agent: Agent { ‚Ä¶ },
        chunkedEncoding: false,
        connection: Socket { ‚Ä¶ },
        finished: true,
        maxHeadersCount: null,
        method: 'GET',
        output: [],
        outputCallbacks: [],
        outputEncodings: [],
        outputSize: 0,
        parser: HTTPParser { ‚Ä¶ },
        path: '/',
        res: null,
        sendDate: false,
        shouldKeepAlive: false,
        socket: Socket { ‚Ä¶ },
        socketPath: undefined,
        timeout: undefined,
        timeoutCb: null,
        upgradeOrConnect: false,
        useChunkedEncodingByDefault: false,
        writable: true,
        [Symbol(isCorked)]: false,
        [Symbol(outHeadersKey)]: Object { ‚Ä¶ },
      },
      _currentUrl: 'http://localhost:3000/',
      _events: {
        error: Function handleRequestError {},
        response: Function handleResponse {},
      },
      _eventsCount: 2,
      _maxListeners: undefined,
      _onNativeResponse: Function {},
      _options: {
        agent: undefined,
        auth: undefined,
        headers: Object { ‚Ä¶ },
        hostname: 'localhost',
        maxBodyLength: 10485760,
        maxRedirects: 21,
        method: 'GET',
        nativeProtocols: Object { ‚Ä¶ },
        path: '/',
        pathname: '/',
        port: '3000',
        protocol: 'http:',
      },
      _redirectCount: 0,
      _redirects: [],
      _requestBodyBuffers: [],
      _requestBodyLength: 0,
      _writableState: WritableState [
        autoDestroy: false,
        bufferProcessing: false,
        bufferedRequest: null,
        bufferedRequestCount: 0,
        corked: 0,
        corkedRequestsFree: Object { ‚Ä¶ },
        decodeStrings: true,
        defaultEncoding: 'utf8',
        destroyed: false,
        emitClose: true,
        ended: false,
        ending: false,
        errorEmitted: false,
        finalCalled: false,
        finished: false,
        highWaterMark: 16384,
        lastBufferedRequest: null,
        length: 0,
        needDrain: false,
        objectMode: false,
        onwrite: Function bound onwrite {},
        pendingcb: 0,
        prefinished: false,
        sync: true,
        writecb: null,
        writelen: 0,
        writing: false,
      ],
      writable: true,
    },
    response: undefined,
    toJSON: Function {},
    message: 'timeout of exceeded',
  }

  createError (node_modules/axios/lib/core/createError.js:16:15)
  Timeout.handleRequestTimeout (node_modules/axios/lib/adapters/http.js:252:16)


üßπ Stop and remove Docker containers...
