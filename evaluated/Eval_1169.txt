
Stop and remove previous Docker containers...

ğŸ³ Generate and run Dockerfile from ./student-code/...

ğŸ‘¾ Run test suite against container...

    Lecture du code source fourni
    â„¹ const express = require('express');
      const bodyParser = require("body-parser");

      const app = express();

      require('dotenv').config();

      app.use(bodyParser.json());

      const PORT = process.env.PORT || 3000;

      app.listen(PORT, () => {
          console.log(`${PORT}`);
      });

      const MongoClient = require("mongodb").MongoClient;
      const url = process.env.MONGODB_URL;
      async function insertName(nom) {
          const client = new MongoClient(url);

          try {
              await client.connect();

              const db = client.db(process.env.MONGODB_DATABASE);
              const collection = db.collection(process.env.MONGODB_COLLECTION);

              await collection.insertOne({
                  name: nom,
              });

              console.log("Messages inserted");
          } catch (error) {
              console.log(error);
          }

          client.close();
      }

      async function getLastName() {
          const client = new MongoClient(url);

          try {
              await client.connect();

              const db = client.db(process.env.MONGODB_DATABASE);
              const collection = db.collection(process.env.MONGODB_COLLECTION);

              const response = await collection.find().sort({ _id: -1 }).limit(1).toArray();

              return response;
          } catch (error) {
              console.log(error);
              return "error";
          }

          client.close();
      }


      app.post("/", (req, res) => {
          const nom = req.body.nom;
          if (nom != undefined) {
              insertName(nom);
              res.send("Bienvenue, " + nom + ".");
          } else {
              res.send("Il manque votre nom.");
          }
      });

      app.get("/", async (req, res) => {
          const nom = await getLastName();
          if (nom[0]["name"] != undefined) {
              res.send("La derniÃ¨re personne que j'ai rencontrÃ©e est: " + nom[0]["name"] + ".");
          }
          else if (nom === "error") {
              res.send("J'ai perdu la mÃ©moire...");
          }
          else {
              res.send("Je n'ai rencontrÃ© personne pour l'instant");
          }
      });


  âœ” server.js utilise seulement await pour rÃ©cupÃ©rer les valeurs promises
  âœ” server.js contient l'inteÌgraliteÌ du code source de votre programme
  âœ” package.json permet d'installer les deÌpendances neÌcessaires aÌ€ l'aide de npm install
  âœ– package.json permet de deÌmarrer le serveur aÌ€ l'aide de npm start `t.regex()` must be called with a string
  âœ– README.md inclue les instructions aÌ€ suivre pour installer, exeÌcuter et tester le serveur 
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'name' of undefined
(node) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). (rejection id: 1)
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'name' of undefined
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'name' of undefined
  âœ– le serveur rÃ©pond sur le port 3000 Rejected promise returned by test
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'name' of undefined
  âœ– (1) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/ 
  âœ” (2) POST / {} -> /Il manque votre nom/
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'name' of undefined
  âœ– (3) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/ 
  âœ– (4) POST / "nom=adrien" -> /Bienvenue, adrien/ 
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'name' of undefined
  âœ– (5) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/ 
  âœ– (6) POST / "nom=michelle" -> /Bienvenue, michelle/ 
(node) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'name' of undefined
  âœ– (7) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/ 
  âœ– MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur 
  âœ– (8) GET / -> "J'ai perdu la meÌmoire...", si la db ne fonctionne plus 
{ MongoNetworkError: failed to connect to server [localhost:27027] on first connect [MongoNetworkError: connect ECONNREFUSED 127.0.0.1:27027]

  11 tests failed

  package.json permet de deÌmarrer le serveur aÌ€ l'aide de npm start

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:99

   98:     const { scripts } = JSON.parse(await runInDocker('cat package.json')â€¦
   99:     t.regex(scripts.start, /node server.js/);                            
   100:   }                                                                      

  `t.regex()` must be called with a string

  Called with:

  undefined



  README.md inclue les instructions aÌ€ suivre pour installer, exeÌcuter et tester le serveur

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:108

   107:     t.regex(readme, /npm i/);                
   108:     t.regex(readme, /node server|npm start/);
   109:     t.regex(readme, /npm test|curl/);        

  Value must match expression:

  `# Partiel NodeJS 1169âŠ
  âŠ
  ## InstallationâŠ
  âŠ
  ```âŠ
  $ npm installâŠ
  ```âŠ
  âŠ
  ### 1 - POSTâŠ
  âŠ
  ```âŠ
  $ curl -X POST --header "Content-Type: application/json" --data "{\\"nom\\":\\"Mathieu\\"}" http://localhost:3000/âŠ
  ```âŠ
  renverra "Bienvenue, Mathieu."âŠ
  âŠ
  ```âŠ
  $ curl -X POST --header "Content-Type: application/json" --data "{\\"nom\\":\\"\\"}" http://localhost:3000/âŠ
  ```âŠ
  âŠ
  renverra "Il manque votre nom."âŠ
  âŠ
  ### 2 - GETâŠ
  âŠ
  ```âŠ
  http://localhost:3000/âŠ
  ```âŠ
  renverra "La derniÃ¨re personne que j'ai rencontrÃ©e est: Mathieu." si la derniÃ¨re personne Ã  avoir Ã©tÃ© ajoutÃ© Ã  la BDD est Mathieu.âŠ
  âŠ
  renverra "La derniÃ¨re personne que j'ai rencontrÃ©e est: Mathieu." si la BDD est vide.âŠ
  âŠ
  renverra "La derniÃ¨re personne que j'ai rencontrÃ©e est: Mathieu." si il y a une erreur.âŠ
  `

  Regular expression:

  /node server|npm start/



  le serveur rÃ©pond sur le port 3000


  Rejected promise returned by test. Reason:

  Error {
    cmd: 'PORT=3000 ./wait-for-student-server.sh',
    code: 1,
    killed: false,
    signal: null,
    stderr: '',
    stdout: `âŠ
    Wait for server on port 3000...âŠ
    (1)âŠ
    (2)âŠ
    (3)âŠ
    âŒ  Server is NOT listening on port 3000.âŠ
    `,
    message: `Command failed: PORT=3000 ./wait-for-student-server.shâŠ
    `,
  }



  (1) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:162

   161:       const { data } = await axios[method.toLowerCase()](url, body);
   162:       t.regex(data, exp);                                           
   163:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /Je n'ai rencontreÌ personne pour l'instant/



  (3) GET / {} -> /Je n'ai rencontreÌ personne pour l'instant/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:162

   161:       const { data } = await axios[method.toLowerCase()](url, body);
   162:       t.regex(data, exp);                                           
   163:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /Je n'ai rencontreÌ personne pour l'instant/



  (4) POST / "nom=adrien" -> /Bienvenue, adrien/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:162

   161:       const { data } = await axios[method.toLowerCase()](url, body);
   162:       t.regex(data, exp);                                           
   163:     }                                                               

  Value must match expression:

  'Il manque votre nom.'

  Regular expression:

  /Bienvenue, adrien/



  (5) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:162

   161:       const { data } = await axios[method.toLowerCase()](url, body);
   162:       t.regex(data, exp);                                           
   163:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /La dernieÌ€re personne que j'ai rencontreÌe est: adrien/



  (6) POST / "nom=michelle" -> /Bienvenue, michelle/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:162

   161:       const { data } = await axios[method.toLowerCase()](url, body);
   162:       t.regex(data, exp);                                           
   163:     }                                                               

  Value must match expression:

  'Il manque votre nom.'

  Regular expression:

  /Bienvenue, michelle/



  (7) GET / {} -> /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:162

   161:       const { data } = await axios[method.toLowerCase()](url, body);
   162:       t.regex(data, exp);                                           
   163:     }                                                               

  Value must match expression:

  'âŒ HTTP Error: Error: timeout of exceeded'

  Regular expression:

  /La dernieÌ€re personne que j'ai rencontreÌe est: michelle/



  MONGODB_COLLECTION ne doit contenir qu'un document avec le nom du dernier visiteur

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:183

   182:     );                                                       
   183:     t.is(docs.length, 1);                                    
   184:     t.deepEqual(Object.keys(docs[0]).sort(), ['_id', 'nom']);

  Difference:

  - 0
  + 1



  (8) GET / -> "J'ai perdu la meÌmoire...", si la db ne fonctionne plus

  /Users/adrienjoly/dev/adrienjoly/cours-nodejs-exercise-testers/test-partiel.js:194

   193:     const { data } = await axios.get(`http://localhost:${envVars.PORT}/â€¦
   194:     t.regex(data, /J'ai perdu la meÌmoire/);                            
   195:   }                                                                     

  Value must match expression:

  'J\'ai perdu la mÃ©moire...'

  Regular expression:

  /J'ai perdu la meÌmoire/


ğŸ§¹ Stop and remove Docker containers...
